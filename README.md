# thd3d8mitigation

Windows 10で破壊的変更が起きたDirect3D 8およびDirect3D 8を用いて作られた東方Projectのゲームを元来の動作に近づけることを目指しているDirect3D 8の互換レイヤーです。Direct3D 8のラッパーとして動作します。 **注意: そうは言っても通常プレイの範疇外なので、節度を守って使ったり本プログラムの使用を明記したりすることをおすすめします。**

現在は主に、フルスクリーンモードの東方紅魔郷がWindows 10で高速化する問題を緩和する効能があります。

## ライセンスおよび免責事項

MIT License。詳細はLICENSE.txtを参照のこと。

## ビルド方法

必要なもの:

- Windows 10
- Visual Studio 2019 (CommunityエディションでOK)
- DirectX SDK August 2007 (https://www.microsoft.com/en-us/download/details.aspx?id=13287)
  - DirectX 8(Direct3D 8を含む)をサポートする最後のSDK
  - SDKのインストールディレクトリはデフォルト(C:\\Program Files (x86)\\Microsoft DirectX SDK (August 2007))で問題ないはずです。詳しくはプロジェクトファイルをご覧ください。

Visual Studioを起動してソリューションファイルを開きます。開いたら構成をDebugではなくReleaseにします。そして、\[ビルド\]→\[ソリューションのビルド\]でビルドします。ビルドの成果物はReleaseフォルダーに出力されます。

## インストール方法

1. d3d8.dllをコピーして、ゲームの実行ファイルがあるフォルダーに貼り付けます。
2. ゲームを起動します。
3. お楽しみください。

**注意: 初期設定では、一部のオプションは環境に適した設定を自動で設定する設定になっています。自動で設定する設定になっている場合は起動時間が少し長くなります。環境構成を厳密に行う必要がある場合は、最初の起動後すぐにゲームを終了して、生成された設定ファイルで設定を確認および変更してから実際に遊ぶことをおすすめします。**

## アンインストール方法

1. インストール時にゲームの実行ファイルがあるフォルダーに貼り付けたd3d8.dllを削除します。
2. 該当ゲームの設定ファイルと同じフォルダーに生成されたthd3d8mitigationcfg.iniとthd3d8mitigationlog.txtを削除します。
3. おつかれさまでした。

## 設定

thd3d8mitigationをインストールした状態でゲームを起動すると、設定ファイルが無い場合は設定ファイルが生成されます。該当ゲームの設定ファイルと同じフォルダーにthd3d8mitigationcfg.iniという設定ファイルがあるはずです。メモ帳などで設定を確認および変更できます。

(正確には、実行ファイルと同じフォルダーに設定ファイルの作成を試みます。そのため、通常はゲームの設定ファイル等を含めそのフォルダーに作成されるのですが、C:\\Program Files (x86)\\配下やC:\\Program Files\\配下などにインストールされている場合、UACの仮想化という機能によりVirtualStoreフォルダー(大抵はC:\\Users\\「ユーザー名」\\AppData\\Local\\VirtualStore\\)配下に作成されます。)

### presentationセクション

#### wait_forオプション

主に、東方紅魔郷がWindows 10で高速化する問題を緩和するためのオプションです。初期設定はautoです。フルスクリーンモード下での表示処理時に行う追加の待機処理の方法を設定します。

- auto: とりあえず動けばいいという場合に推奨されます。環境に合わせて最適な設定を自動で設定します。 **注意: 一部注意が必要な設定が選択されることがあります。詳しくはtimer60の注釈をご覧ください。環境構成を厳密に行う必要がある場合はこの設定を避けてください。この設定を設定すると起動時間が少し長くなります。**
- vsync: Windows 10でプレイする際に推奨されます。通常の処理に加え、独自の方法で垂直同期信号の待機を試みます。
- normal: Windows 10以外の環境(10より前の版のWindows(7など)や、WineおよびProton等の互換レイヤーなど)でプレイする際に推奨されます。特に何もせず通常通りの処理のみを行います。
- timer60: 垂直同期信号が60Hzより高い環境でプレイする際に推奨されます。通常の処理に加え、高精度タイマーを用いて60FPSになるように待機を試みます。 **注意: Direct3D 8の互換レイヤーとしては元来の仕様から外れる設定です。thd3d8mitigationは原則として元来の動作に近づけることを目的としていますが、この設定は元来の仕様の東方紅魔郷が正常に動作しない一部の環境で正常に近い動作を試みるために例外的に設けられました。気になる方は、この設定は設定しないことをおすすめします。**

## バージョンの確認

ゲームの起動時に、該当ゲームの設定ファイルと同じフォルダーに生成されたthd3d8mitigationlog.txtに記録されます。

## 動作確認

- 東方紅魔郷 v1.02h ノーマル 霊夢A
  - 作者のシューティング力が不足しているため、Hard、Lunatic、Extraでの動作確認は取れていません。
